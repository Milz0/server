{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>Agents ([[numAgents]])</h2>

{%TEMPLATE->struct/messages%}

<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered table-sm table-hover align-middle" id="agents">
      <thead>
        <tr>
          <th scope="col">Id</th>
          <th scope="col">Act</th>
          <th scope="col">Name / Owner / Client</th>
          <th scope="col">GPUs/CPUs</th>
          <th scope="col">CPU only</th>
          <th scope="col">Last activity</th>
          <th scope="col">Access Groups</th>
          <th scope="col">Action</th>
        </tr>
      </thead>

      <tbody>
        {{FOREACH agent;[[agents]]}}
          <tr>
            <td>
              <a href="agents.php?id=[[agent.getId()]]">[[agent.getId()]]</a>
            </td>

            <td data-sort="[[agent.getIsActive()]]">
              <form id="active[[agent.getId()]]" action="agents.php" method="post" class="m-0">
                <input type="hidden" name="action" value="[[$DAgentAction::SET_ACTIVE]]">
                <input type="hidden" name="agentId" value="[[agent.getId()]]">
                <input type="hidden" name="csrf" value="[[csrf]]">

                <div class="form-check m-0">
                  <input class="form-check-input"
                         type="checkbox"
                         id="actcb[[agent.getId()]]"
                         {{IF [[agent.getIsActive()]] == 1}}checked{{ENDIF}}
                         {{IF [[agent.getUserId()]] != [[login.getUserId()]] && ![[accessControl.hasPermission([[$DAccessControl::MANAGE_AGENT_ACCESS]])]]}}disabled{{ENDIF}}
                         onChange="document.getElementById('active[[agent.getId()]]').submit();"
                         title="Is Active">
                  <label class="form-check-label" for="actcb[[agent.getId()]]"></label>
                </div>
              </form>
            </td>

            <td data-sort="[[agent.getAgentName()]]">
              <a href="agents.php?id=[[agent.getId()]]">[[agent.getAgentName()]]</a>
              {{IF [[agent.getIsTrusted()]] == 1}}
                <span class="fas fa-lock" aria-hidden="true"></span>
              {{ENDIF}}
              {{IF [[agent.getIsActive()]] == 0}}
                <span class="fas fa-pause-circle" aria-hidden="true"></span>
              {{ENDIF}}

              <div class="mt-1">
                {{IF [[agent.getUserId()]] > 0}}
                  [[Util::getUsernameById([[agent.getUserId()]])]]
                {{ELSE}}
                  ---
                {{ENDIF}}
              </div>

              <div class="mt-1">
                {{IF strlen([[agent.getClientSignature()]]) > 0}}
                  <span class="text-muted">Running:</span> [[agent.getClientSignature()]]
                {{ELSE}}
                  <span class="text-muted">Running:</span> unknown
                {{ENDIF}}
              </div>
            </td>

            <td style="white-space: normal;">
              [[str_replace("\n","<br>",[[agent.getDevices()]])]]
            </td>

            <td>
              {{IF [[agent.getCpuOnly()]] == 0}}No{{ELSE}}Yes{{ENDIF}}
            </td>

            <td style="white-space: normal;">
              <code>[[agent.getLastAct()]]</code> at<br>
              [[date([[config.getVal(DConfig::TIME_FORMAT)]], [[agent.getLastTime()]])]]<br>
              IP:
              {{IF [[config.getVal([[$DConfig::HIDE_IP_INFO]])]] == 0}}
                <code>[[agent.getLastIp()]]</code>
              {{ELSE}}
                <code>Hidden</code>
              {{ENDIF}}
            </td>

            <td style="white-space: normal;">
              {{FOREACH accessGroup;[[accessGroupAgents.getVal([[agent.getId()]])]]}}
                [[accessGroup.getGroupName()]]<br>
              {{ENDFOREACH}}
            </td>

            <td>
              {{IF [[accessControl.hasPermission([[$DAccessControl::MANAGE_AGENT_ACCESS]])]]}}
                <form action="agents.php" method="POST" class="m-0" onSubmit="if (!confirm('Really delete agent [[agent.getId()]]?')) return false;">
                  <input type="hidden" name="action" value="[[$DAgentAction::DELETE_AGENT]]">
                  <input type="hidden" name="agentId" value="[[agent.getId()]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <button type="submit" class="btn btn-danger btn-sm" data-toggle="tooltip" data-placement="top" title="Delete">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                  </button>
                </form>
              {{ELSE}}
                &nbsp;
              {{ENDIF}}
            </td>
          </tr>
        {{ENDFOREACH}}
      </tbody>
    </table>

    <script type="text/javascript">
      $(document).ready(function () {
        $('#agents').DataTable({
          pageLength: 50,
          order: [[0, 'asc']],
          columnDefs: [
            { orderable: false, targets: [5, 7] },
            { orderable: true, targets: [0, 1, 2, 3, 4, 6] }
          ]
        });
      });
    </script>
  </div>
</div>

{%TEMPLATE->struct/foot%}