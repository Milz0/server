{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2 class="mb-3">Rent Agents</h2>
{%TEMPLATE->struct/messages%}

<link rel="stylesheet" href="static/vastai.css">

<div class="vast-page">
  <div class="row g-3">

    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-semibold d-flex align-items-center gap-2 flex-wrap">
              <span>My instances</span>

              <span id="runningHourlyWrap" class="d-none">
                <span class="vast-badge is-info" id="runningHourlyBadge" title="Total running $/hr">
                  <span class="dot"></span>
                  <span id="runningHourlyText">Running: $0.00/hr</span>
                </span>
              </span>

              <span id="selectedHourlyWrap" class="d-none">
                <span class="vast-badge is-good" id="selectedHourlyBadge" title="Total selected $/hr from offers">
                  <span class="dot"></span>
                  <span id="selectedHourlyText">Selected: $0.00/hr</span>
                </span>
              </span>
            </div>
            <small class="muted">Live view from Vast.ai account</small>
          </div>

          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="text-muted">Rows: <span id="instanceCount">[[sizeof([[vastInstances]])]]</span></span>
          </div>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive vast-scroll vast-sticky">
            <table class="table table-bordered table-hover table-sm align-middle mb-0" id="instancesTable">
              <thead>
                <tr>
                  <th style="width:120px;">ID</th>
                  <th class="col-label">Label</th>
                  <th style="width:160px;">Status</th>
                  <th style="width:220px;">GPU</th>
                  <th style="width:90px;" class="text-center">GPUs</th>
                  <th style="width:140px;" class="text-end">$/hr</th>
                  <th style="width:170px;">IP:SSH</th>
                  <th style="width:170px;">Started</th>
                  <th style="width:320px; white-space:nowrap;">Actions</th>
                </tr>
              </thead>

              <tbody>
                {{FOREACH inst;[[vastInstances]]}}
                <tr class="instanceRow">
                  <td><code>[[inst.getVal('id')]]</code></td>
                  <td class="col-label">[[inst.getVal('label')]]</td>
                  <td>
                    <span class="vast-badge is-muted js-status-badge">[[inst.getVal('status')]]</span>
                  </td>
                  <td>[[inst.getVal('gpu_name')]]</td>
                  <td class="text-center">[[inst.getVal('num_gpus')]]</td>
                  <td class="text-end instanceCost">[[inst.getVal('cost_per_hour')]]</td>
                  <td>
                    {{IF [[inst.getVal('public_ip')]] != ""}}
                    <code>[[inst.getVal('public_ip')]]:[[inst.getVal('ssh_port')]]</code>
                    {{ENDIF}}
                  </td>
                  <td><code>[[inst.getVal('start')]]</code></td>

                  <td style="white-space: nowrap;">
                    <div class="d-inline-flex align-items-center gap-1" role="group" aria-label="Instance actions">
                      <form method="POST" action="" class="m-0">
                        <input type="hidden" name="csrf" value="[[csrf]]">
                        <input type="hidden" name="action" value="vastStart">
                        <input type="hidden" name="instance_id" value="[[inst.getVal('id')]]">
                        <button type="submit" class="btn btn-secondary btn-sm">Start</button>
                      </form>

                      <form method="POST" action="" class="m-0">
                        <input type="hidden" name="csrf" value="[[csrf]]">
                        <input type="hidden" name="action" value="vastStop">
                        <input type="hidden" name="instance_id" value="[[inst.getVal('id')]]">
                        <button type="submit" class="btn btn-warning btn-sm">Stop</button>
                      </form>

                      <form method="POST" action="" class="m-0"
                        onsubmit="return confirm('Destroy this instance on Vast.ai? This cannot be undone.');">
                        <input type="hidden" name="csrf" value="[[csrf]]">
                        <input type="hidden" name="action" value="vastDestroy">
                        <input type="hidden" name="instance_id" value="[[inst.getVal('id')]]">
                        <button type="submit" class="btn btn-danger btn-sm">Destroy</button>
                      </form>
                    </div>
                  </td>
                </tr>
                {{ENDFOREACH}}

                {{IF [[sizeof([[vastInstances]])]] == 0}}
                <tr>
                  <td colspan="9" class="text-muted">No instances loaded.</td>
                </tr>
                {{ENDIF}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xxl-4">
      <div class="card">
        <div class="card-header">
          <div class="fw-semibold">Search offers</div>
          <small class="text-muted">On-demand default. Optional: reserved, bid</small>
        </div>

        <div class="card-body">

          <form method="POST" action="" id="vastSearchForm">
            <input type="hidden" name="csrf" value="[[csrf]]">
            <input type="hidden" name="action" value="vastSearch">

            <div class="d-grid mb-3">
              <button type="submit" class="btn btn-primary">Search</button>
            </div>

            <div class="alert alert-info vast-panel-block mb-3">
              Tip: Select multiple offers, then click <b>Rent selected</b>.
            </div>

            <div class="vast-panel-block mb-3">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <span class="text-muted">Quick filter</span>
                <small class="text-muted">Current results only</small>
              </div>
              <input class="form-control" type="text" id="offerFilter" placeholder="Filter by GPU name">
            </div>

            <div class="vast-panel-block mb-3">
              <label class="form-label">Sort offers</label>
              <select class="form-select" id="offerSort">
                <option value="fpd_desc" selected>Best value (FLOPS per $) high to low</option>
                <option value="hour_asc">$/hr low to high</option>
                <option value="hour_desc">$/hr high to low</option>
                <option value="flops_desc">Total FLOPS high to low</option>
                <option value="rel_desc">Reliability high to low</option>
                <option value="up_desc">Upload Mbps high to low</option>
                <option value="down_desc">Download Mbps high to low</option>
                <option value="ng_asc">GPU count low to high</option>
                <option value="ng_desc">GPU count high to low</option>
              </select>
              <small class="text-muted d-block mt-1">Sorting applies to the current results only.</small>
            </div>

            <hr class="my-3">

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label mb-1">Minimum GPUs</label>
                <input class="form-control" type="number" name="num_gpus" value="1" min="1">
              </div>

              <div class="col-6">
                <label class="form-label mb-1">Min reliability</label>
                <input class="form-control" type="number" name="min_reliability" value="0.95" step="0.01" min="0"
                  max="1">
              </div>

              <div class="col-12">
                <label class="form-label mb-1">GPU names (optional)</label>
                <input class="form-control" type="text" name="gpu_names_csv" placeholder="RTX 4090, A100, RTX 3090">
                <small class="text-muted">Comma-separated. Leave blank for any GPU.</small>
              </div>

              <div class="col-12">
                <label class="form-label mb-1">Types</label>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="typeReserved" name="include_reserved" value="1">
                    <label class="form-check-label" for="typeReserved">Reserved</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="typeBid" name="include_bid" value="1">
                    <label class="form-check-label" for="typeBid">Bid (interruptible)</label>
                  </div>
                </div>
                <small class="text-muted d-block mt-1">On-demand is always included by default.</small>
              </div>

              <div class="col-12">
                <label class="form-label mb-1">Limit</label>
                <input class="form-control" type="number" name="limit" value="256" min="1" max="500">
                <small class="text-muted">Controls how many offers are fetched per type (server-side clamp
                  applies).</small>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>

    <div class="col-12 col-xxl-8">
      <div class="card">
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="fw-semibold">Offers</div>
            <small class="muted">Client-side filter, sort, and pagination after results load</small>
          </div>

          <div class="d-flex align-items-center gap-2 flex-wrap">
            <small class="text-muted" id="selectedCount">0 selected</small>

            <form method="POST" action="" id="vastRentMultiForm" class="m-0">
              <input type="hidden" name="csrf" value="[[csrf]]">
              <input type="hidden" name="action" value="vastRentMulti">
              <button type="submit" class="btn btn-success btn-sm" id="btnRentSelected" disabled>Rent selected</button>
            </form>
          </div>
        </div>

        <div class="card-body p-0">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 p-2 border-bottom">
            <div class="d-flex align-items-center gap-2 flex-wrap vast-pager">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="offerPrev"
                title="Previous page">Prev</button>
              <span class="text-muted small" id="offerPageText">Page 1 / 1</span>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="offerNext"
                title="Next page">Next</button>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="text-muted small" id="offerRangeText">Showing 0â€“0 of 0</span>
              <div class="d-flex align-items-center gap-2">
                <label class="text-muted small mb-0" for="offerPageSize">Page size</label>
                <select class="form-select form-select-sm" id="offerPageSize" style="width: auto;">
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                  <option value="200">200</option>
                </select>
              </div>
            </div>
          </div>

          <div class="vast-table-wrap table-responsive vast-scroll vast-sticky">
            <table class="table table-bordered table-sm table-hover align-middle mb-0" id="offersTable">
              <thead>
                <tr>
                  <th class="col-check">
                    <input type="checkbox" id="selectAllOffers" title="Select all visible">
                  </th>
                  <th>Ask</th>
                  <th style="width:120px;">Type</th>
                  <th class="col-gpu">GPU</th>
                  <th class="text-center">GPUs</th>
                  <th class="text-end">$/hr</th>
                  <th class="text-end">Total Flops</th>
                  <th class="text-end">Up</th>
                  <th class="text-end">Down</th>
                  <th class="col-actions">Action</th>
                </tr>
              </thead>

              <tbody>
                {{FOREACH offer;[[vastOffers]]}}
                <tr class="offerRow" data-ask="[[offer.getVal('ask_contract_id')]]"
                  data-type="[[offer.getVal('offer_type_raw')]]" data-gpu="[[offer.getVal('gpu_name')]]"
                  data-ng="[[offer.getVal('num_gpus')]]" data-hour="[[offer.getVal('totalHour_raw')]]"
                  data-rel="[[offer.getVal('reliability_raw')]]" data-up="[[offer.getVal('inet_up_raw')]]"
                  data-down="[[offer.getVal('inet_down_raw')]]" data-flops="[[offer.getVal('total_flops_raw')]]"
                  data-fpd="[[offer.getVal('flops_per_dollar_raw')]]">

                  <td class="col-check">
                    {{IF [[offer.getVal('ask_contract_id')]] != ""}}
                    <input class="form-check-input offerSelect" type="checkbox"
                      value="[[offer.getVal('ask_contract_id')]]" title="Select">
                    {{ENDIF}}
                  </td>

                  <td><code>[[offer.getVal('ask_contract_id')]]</code></td>

                  <td>
                    <span class="vast-badge offerTypeBadge is-muted" title="Offer type">
                      <span class="dot"></span>
                      [[offer.getVal('offer_type')]]
                    </span>
                  </td>

                  <td class="offerGpuName">[[offer.getVal('gpu_name')]]</td>
                  <td class="text-center">[[offer.getVal('num_gpus')]]</td>
                  <td class="text-end">[[offer.getVal('totalHour_disp')]]</td>
                  <td class="text-end">[[offer.getVal('total_flops_disp')]]</td>
                  <td class="text-end">[[offer.getVal('inet_up_disp')]]</td>
                  <td class="text-end">[[offer.getVal('inet_down_disp')]]</td>

                  <td class="col-actions">
                    {{IF [[offer.getVal('ask_contract_id')]] != ""}}
                    <form method="POST" action="" class="m-0 d-inline">
                      <input type="hidden" name="csrf" value="[[csrf]]">
                      <input type="hidden" name="action" value="vastRent">
                      <input type="hidden" name="ask_contract_id" value="[[offer.getVal('ask_contract_id')]]">
                      <button type="submit" class="btn btn-success btn-sm">Rent</button>
                    </form>
                    {{ELSE}}
                    <span class="text-muted">No ask_contract_id</span>
                    {{ENDIF}}
                  </td>
                </tr>
                {{ENDFOREACH}}

                {{IF [[sizeof([[vastOffers]])]] == 0}}
                <tr>
                  <td colspan="10" class="text-muted">
                    No offers loaded. Use the search form to retrieve offers.
                  </td>
                </tr>
                {{ENDIF}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="static/vastai.js"></script>
{%TEMPLATE->struct/foot%}