{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>Add new agent</h2>

{%TEMPLATE->struct/messages%}

<div class="alert alert-info">
  <p class="mb-2">
    To add new agents provide them with a valid voucher and download a client.
  </p>
  <p class="mb-2">
    Used vouchers are automatically deleted to prevent double spending.
  </p>
  <p class="mb-2">
    If you are asked to provide the API url on the client to connect to, you need to enter the following:
  </p>
  <code class="d-block">[[apiUrl]]</code>
</div>

<h3>Clients</h3>
<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Version</th>
          <th>Type</th>
          <th>Operating Systems</th>
          <th>Filename</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {{FOREACH binary;[[agentBinaries]]}}
          <tr>
            <td>[[binary.getId()]]</td>
            <td>[[binary.getVersion()]]</td>
            <td>[[binary.getType()]]</td>
            <td>[[binary.getOperatingSystems()]]</td>
            <td>[[binary.getFilename()]]</td>
            <td>
              <div class="d-flex flex-column gap-2">
                <form action="agents.php?new=true" method="POST" class="m-0">
                  <input type="hidden" name="action" value="[[$DAgentAction::DOWNLOAD_AGENT]]">
                  <input type="hidden" name="binary" value="[[binary.getId()]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <input type="submit" class="btn btn-primary" value="Download">
                </form>
                <code class="d-block text-break mb-0">[[agentUrl]][[binary.getId()]]</code>
              </div>
            </td>
          </tr>
        {{ENDFOREACH}}
      </tbody>
    </table>
  </div>
</div>

{{IF [[sizeof([[vouchers]])]] > 0}}
  <h3 class="mt-3">Vouchers</h3>
  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered align-middle mb-0">
        <thead>
          <tr>
            <th>Voucher</th>
            <th>Created</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {{FOREACH voucher;[[vouchers]]}}
            <tr>
              <td><code class="text-break">[[voucher.getVoucher()]]</code></td>
              <td>[[date([[config.getVal(DConfig::TIME_FORMAT)]], [[voucher.getTime()]])]]</td>
              <td>
                <form action="agents.php?new=true" method="POST" class="m-0"
                      onSubmit="if (!confirm('Really delete this voucher?')) return false;">
                  <input type="hidden" name="action" value="[[$DAgentAction::DELETE_VOUCHER]]">
                  <input type="hidden" name="voucher" value="[[voucher.getId()]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <input type="submit" class="btn btn-danger" value="Delete">
                </form>
              </td>
            </tr>
          {{ENDFOREACH}}
        </tbody>
      </table>
    </div>
  </div>
{{ENDIF}}

<form action="agents.php?new=true" method="POST" class="mt-3">
  <input type="hidden" name="action" value="[[$DAgentAction::CREATE_VOUCHER]]">
  <input type="hidden" name="csrf" value="[[csrf]]">

  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered align-middle mb-0">
        <thead>
          <tr>
            <th colspan="3">Create voucher</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="width: 20%;">New voucher</td>
            <td>
              <input type="text" class="form-control" name="newvoucher" value="[[Util::randomString(8)]]" title="Voucher Code">
            </td>
            <td style="width: 1%; white-space: nowrap;">
              <input type="submit" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}" value="Create">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</form>

{%TEMPLATE->struct/foot%}