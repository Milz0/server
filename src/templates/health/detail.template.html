{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>Health Check [[check.getId()]]</h2>

{%TEMPLATE->struct/messages%}

<div class="card mb-3">
  <div class="table-responsive">
    <table class="table table-bordered align-middle mb-0">
      <tbody>
        <tr>
          <th style="width: 180px;">Time Created</th>
          <td>[[date([[config.getVal([[$DConfig::TIME_FORMAT]])]], [[check.getTime()]])]]</td>
        </tr>
        <tr>
          <th>Status</th>
          <td>
            {{IF [[check.getStatus()]] == [[$DHealthCheckStatus::PENDING]]}}
              <span class="badge badge-warning">Running</span>
            {{ENDIF}}
            {{IF [[check.getStatus()]] == [[$DHealthCheckStatus::COMPLETED]]}}
              <span class="badge badge-success">Completed</span>
            {{ENDIF}}
            {{IF [[check.getStatus()]] == [[$DHealthCheckStatus::ABORTED]]}}
              <span class="badge badge-secondary">Aborted</span>
            {{ENDIF}}
          </td>
        </tr>
        <tr>
          <th>Report</th>
          <td>
            <form class="form-inline flex-wrap" method="get" action="report.php">
              <input type="hidden" name="checkId" value="[[check.getId()]]">
              <select class="form-control mx-1 my-1" name="report" title="Report">
                {{FOREACH report;[[Util::scanReportDirectory('health-check', true)]]}}
                  <option value="[[strtolower([[report]])]]">[[report]]</option>
                {{ENDFOREACH}}
              </select>
              <button type="submit" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}} mx-1 my-1">
                Download
              </button>
            </form>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<h3>Checked Agents ([[sizeof([[checkAgents]])]])</h3>

<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle mb-0">
      <thead>
        <tr>
          <th style="width: 90px;">ID</th>
          <th>Agent</th>
          <th style="width: 160px;">Status</th>
          <th style="width: 140px;">Time Required</th>
          <th style="width: 110px;"># Devices</th>
          <th style="width: 170px;">Cracked</th>
          <th>Errors</th>
          <th style="width: 120px;">Action</th>
        </tr>
      </thead>

      <tbody>
        {{FOREACH checkAgent;[[checkAgents]]}}
          <tr>
            <td>[[checkAgent.getId()]]</td>

            <td>
              <a href="agents.php?id=[[checkAgent.getAgentId()]]">
                [[agentSet.getVal([[checkAgent.getAgentId()]])->getAgentName()]]
              </a>
            </td>

            <td>
              {{IF [[checkAgent.getStatus()]] == [[$DHealthCheckAgentStatus::PENDING]]}}
                <span class="badge badge-warning">Running / Waiting</span>
              {{ENDIF}}
              {{IF [[checkAgent.getStatus()]] == [[$DHealthCheckAgentStatus::COMPLETED]]}}
                <span class="badge badge-success">Completed</span>
              {{ENDIF}}
              {{IF [[checkAgent.getStatus()]] == [[$DHealthCheckAgentStatus::FAILED]]}}
                <span class="badge badge-danger">Failed</span>
              {{ENDIF}}
            </td>

            <td class="text-nowrap">
              {{IF [[checkAgent.getStatus()]] != [[$DHealthCheckAgentStatus::PENDING]]}}
                [[Util::calculate([[checkAgent.getEnd()]] - [[checkAgent.getStart()]])]] seconds
              {{ELSE}}
                <span class="text-muted">N/A</span>
              {{ENDIF}}
            </td>

            <td class="text-nowrap">
              {{IF [[checkAgent.getStatus()]] != [[$DHealthCheckAgentStatus::PENDING]]}}
                [[checkAgent.getNumGpus()]]
              {{ELSE}}
                <span class="text-muted">N/A</span>
              {{ENDIF}}
            </td>

            <td class="text-nowrap">
              {{IF [[checkAgent.getStatus()]] != [[$DHealthCheckAgentStatus::PENDING]]}}
                [[checkAgent.getCracked()]] of [[check.getExpectedCracks()]]
              {{ELSE}}
                <span class="text-muted">N/A</span>
              {{ENDIF}}
            </td>

            <td style="white-space: normal;">
              {{IF [[checkAgent.getStatus()]] != [[$DHealthCheckAgentStatus::PENDING]]}}
                <pre class="mb-0">[[json_encode(json_decode([[checkAgent.getErrors()]], true), JSON_PRETTY_PRINT)]]</pre>
              {{ELSE}}
                <span class="text-muted">N/A</span>
              {{ENDIF}}
            </td>

            <td class="text-nowrap">
              {{IF [[checkAgent.getStatus()]] != [[$DHealthCheckAgentStatus::PENDING]]}}
                <form class="d-inline" method="post" action="" onsubmit="return confirm('Restart this agent check?');">
                  <input type="hidden" name="action" value="[[$DHealthCheckAction::RESET_AGENT]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <input type="hidden" name="healthCheckAgentId" value="[[checkAgent.getId()]]">
                  <button type="submit" class="btn btn-danger">Restart</button>
                </form>
              {{ELSE}}
                <span class="text-muted">â€”</span>
              {{ENDIF}}
            </td>
          </tr>
        {{ENDFOREACH}}

        {{IF [[sizeof([[checkAgents]])]] == 0}}
          <tr>
            <td colspan="8" class="text-center text-muted">No agents have been checked yet.</td>
          </tr>
        {{ENDIF}}
      </tbody>
    </table>
  </div>
</div>

{%TEMPLATE->struct/foot%}
