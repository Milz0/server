{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>Supertask Details</h2>

{%TEMPLATE->struct/messages%}

{{IF ! [[supertask]]}}
  <div class="alert alert-danger">Invalid supertask!</div>
{{ELSE}}

  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle mb-0">
        <tbody>
          <tr>
            <th style="width: 220px;">Supertask ID</th>
            <td>[[supertask.getId()]]</td>
          </tr>

          <tr>
            <th>Name</th>
            <td>[[supertask.getSupertaskName()]]</td>
          </tr>

          <tr>
            <th>Actions</th>
            <td>
              <div class="d-flex flex-wrap gap-2">
                {{IF [[accessControl.hasPermission([[$DAccessControl::RUN_TASK_ACCESS]])]]}}
                  <form action="supertasks.php?new=true&id=[[supertask.getId()]]" method="post" class="m-0">
                    <input type="hidden" name="csrf" value="[[csrf]]">
                    <button type="submit" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}">
                      Apply to Hashlist
                    </button>
                  </form>
                {{ENDIF}}

                {{IF [[accessControl.hasPermission([[$DAccessControl::MANAGE_SUPERTASK_ACCESS]])]]}}
                  <form action="supertasks.php?id=[[supertask.getId()]]" method="POST" class="m-0"
                        onSubmit="if (!confirm('Really delete supertask [[supertask.getId()]]?')) return false;">
                    <input type="hidden" name="action" value="[[$DSupertaskAction::DELETE_SUPERTASK]]">
                    <input type="hidden" name="supertask" value="[[supertask.getId()]]">
                    <input type="hidden" name="csrf" value="[[csrf]]">
                    <button type="submit" class="btn btn-danger">Delete</button>
                  </form>
                {{ENDIF}}
              </div>
            </td>
          </tr>

          <tr>
            <th>Estimate runtime</th>
            <td>
              <form action="supertasks.php?id=[[supertask.getId()]]" method="POST" id="keyspaceCalculation" class="m-0">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-lg-4">
                    <label class="form-label mb-1"><i>Benchmark for -a0 attacks:</i></label>
                    <input type="number" step="1" min="0" name="benchmarka0" class="form-control" title="Hashes per second" value="[[benchmarka0]]">
                  </div>
                  <div class="col-12 col-lg-4">
                    <label class="form-label mb-1"><i>Benchmark for -a3 attacks:</i></label>
                    <input type="number" step="1" min="0" name="benchmarka3" class="form-control" title="Hashes per second" value="[[benchmarka3]]">
                  </div>
                  <div class="col-12 col-lg-4">
                    <button type="submit" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}} w-100">
                      Calculate runtime
                    </button>
                  </div>
                </div>
              </form>
            </td>
          </tr>

          {{IF [[benchmarka0]] != 0 AND [[benchmarka3]] != 0}}
            <tr>
              <th>Estimated total runtime of supertask</th>
              <td class="runtimeOfSupertask"></td>
            </tr>
          {{ENDIF}}

          <tr>
            <td colspan="2">
              The benchmark number to enter above is the total amount of hashes per second per attack type of all of the agents combined that will run the supertask.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h4>Pretasks part of this supertask</h4>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle mb-0" id="pretasksOfSupertasks">
        <thead>
          <tr>
            <th style="width: 120px;">Pretask ID</th>
            <th style="width: 220px;">Name</th>
            <th>Attack command</th>
            <th style="width: 170px;">Estimated keyspace</th>
            <th style="width: 160px;">Attack runtime</th>
            <th style="width: 120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {{FOREACH task;[[tasks]]}}
            <tr class="taskInSuper">
              <td{{IF [[strlen([[task.getColor()]])]] > 0}} style="background-color: #[[task.getColor()]]"{{ENDIF}}>
                {{IF [[accessControl.hasPermission([[$DAccessControl::VIEW_PRETASK_ACCESS]])]]}}
                  <a href="pretasks.php?id=[[task.getId()]]">[[task.getId()]]</a>
                {{ELSE}}
                  [[task.getId()]]
                {{ENDIF}}
              </td>

              <td>
                {{IF [[accessControl.hasPermission([[$DAccessControl::VIEW_PRETASK_ACCESS]])]]}}
                  <a href="pretasks.php?id=[[task.getId()]]">[[task.getTaskName()]]</a>
                {{ELSE}}
                  [[task.getTaskName()]]
                {{ENDIF}}
              </td>

              <td class="attackCmd">[[task.getAttackCmd()]]</td>

              <td>[[pretaskAuxiliaryKeyspace.getVal([[task.getId()]])]]</td>

              <td class="attackRuntime"></td>

              <td>
                {{IF [[accessControl.hasPermission([[$DAccessControl::MANAGE_SUPERTASK_ACCESS]])]]}}
                  <form action="supertasks.php?id=[[supertask.getId()]]&benchmarka0=[[benchmarka0]]&benchmarka3=[[benchmarka3]]"
                        method="POST" class="m-0"
                        onSubmit="if (!confirm('Really remove pretask [[task.getId()]] from this supertask [[supertask.getId()]]?')) return false;">
                    <input type="hidden" name="action" value="[[$DSupertaskAction::REMOVE_PRETASK_FROM_SUPERTASK]]">
                    <input type="hidden" name="supertaskId" value="[[supertask.getId()]]">
                    <input type="hidden" name="pretaskId" value="[[task.getId()]]">
                    <input type="hidden" name="csrf" value="[[csrf]]">
                    <input type="hidden" name="benchmarka0" value="[[benchmarka0]]">
                    <input type="hidden" name="benchmarka3" value="[[benchmarka3]]">
                    <button type="submit" class="btn btn-danger btn-sm w-100">Remove</button>
                  </form>
                {{ENDIF}}
              </td>
            </tr>
          {{ENDFOREACH}}
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h4>Pretasks not part of this supertask</h4>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle mb-0" id="remainingPretasks">
        <thead>
          <tr>
            <th style="width: 120px;">Pretask ID</th>
            <th style="width: 220px;">Name</th>
            <th>Attack command</th>
            <th style="width: 170px;">Estimated keyspace</th>
            <th style="width: 160px;">Attack runtime</th>
            <th style="width: 120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {{FOREACH pretask;[[allOtherPretasks]]}}
            <tr class="taskNotInSuper">
              <td{{IF [[strlen([[pretask.getColor()]])]] > 0}} style="background-color: #[[pretask.getColor()]]"{{ENDIF}}>
                {{IF [[accessControl.hasPermission([[$DAccessControl::VIEW_PRETASK_ACCESS]])]]}}
                  <a href="pretasks.php?id=[[pretask.getId()]]">[[pretask.getId()]]</a>
                {{ELSE}}
                  [[pretask.getId()]]
                {{ENDIF}}
              </td>

              <td>
                {{IF [[accessControl.hasPermission([[$DAccessControl::VIEW_PRETASK_ACCESS]])]]}}
                  <a href="pretasks.php?id=[[pretask.getId()]]">[[pretask.getTaskName()]]</a>
                {{ELSE}}
                  [[pretask.getTaskName()]]
                {{ENDIF}}
              </td>

              <td>[[pretask.getAttackCmd()]]</td>

              <td>[[pretaskAuxiliaryKeyspace.getVal([[pretask.getId()]])]]</td>

              <td class="attackRuntime"></td>

              <td>
                {{IF [[accessControl.hasPermission([[$DAccessControl::MANAGE_SUPERTASK_ACCESS]])]]}}
                  <form action="supertasks.php?id=[[supertask.getId()]]&benchmarka0=[[benchmarka0]]&benchmarka3=[[benchmarka3]]"
                        method="POST" class="m-0"
                        onSubmit="if (!confirm('Really add pretask [[pretask.getId()]] to this supertask [[supertask.getId()]]?')) return false;">
                    <input type="hidden" name="action" value="[[$DSupertaskAction::ADD_PRETASK_TO_SUPERTASK]]">
                    <input type="hidden" name="supertaskId" value="[[supertask.getId()]]">
                    <input type="hidden" name="pretaskId" value="[[pretask.getId()]]">
                    <input type="hidden" name="csrf" value="[[csrf]]">
                    <input type="hidden" name="benchmarka0" value="[[benchmarka0]]">
                    <input type="hidden" name="benchmarka3" value="[[benchmarka3]]">
                    <button type="submit" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}} btn-sm w-100">Add</button>
                  </form>
                {{ENDIF}}
              </td>
            </tr>
          {{ENDFOREACH}}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Parse attack command and compute runtime based on benchmark from form input value -->
  <script src="static/optparse.1.1.1.js"></script>
  <script src="static/optparse.hashtopolis.1.1.1.js"></script>

  <script>
    function calc_keyspace_size(cmd) {
      // resetting the options
      options = defaultOptions;
      options.ruleFiles = [];
      options.posArgs = [];
      options.unrecognizedFlag = [];

      // example cmd = "hashcat #HL# -a3 ?d?d?d?d"
      // Ideally the opt-parser itself works for '-a3' instead of requiring a space as in '-a 3' to parse attackType
      args = cmd.replace('hashcat', '');
      args = args.replace(/(-a)(\d)(\s)/, "-a $2 ");   // "-a3" => "-a 3"
      args = args.replace(/(-\d)(\S+)(\s)/, "$1 $2 "); // "-1?l?d" => "-1 ?l?d"
      args = args.replace(/\s+/g, ' ');
      args = args.trim();
      args = args.split(/ |=/g);

      parser.parse(args);

      function customCharsetToOptions(mask) {
        numA  = (mask.match(/\?a/g) || []).length;
        numD  = (mask.match(/\?d/g) || []).length;
        numL  = (mask.match(/\?l/g) || []).length;
        numU  = (mask.match(/\?u/g) || []).length;
        numS  = (mask.match(/\?s/g) || []).length;
        numLH = (mask.match(/\?h/g) || []).length;
        numUH = (mask.match(/\?H/g) || []).length;
        numB  = (mask.match(/\?b/g) || []).length;

        var charsetOptions = 95 * Math.min(1, numA);
        charsetOptions = charsetOptions + 10 * Math.min(1, numD);
        charsetOptions = charsetOptions + 26 * Math.min(1, numL);
        charsetOptions = charsetOptions + 26 * Math.min(1, numU);
        charsetOptions = charsetOptions + 33 * Math.min(1, numS);
        charsetOptions = charsetOptions + 16 * Math.min(1, numLH);
        charsetOptions = charsetOptions + 16 * Math.min(1, numUH);
        charsetOptions = charsetOptions + 256 * Math.min(1, numB);

        charsetOptions = charsetOptions + mask.length - 2 * (numA + numD + numL + numU + numS + numLH + numUH + numB);
        return charsetOptions;
      }

      function maskToKeyspace(mask) {
        var keyspaceCustomMask = 1;

        if (options.customCharset1 !== "") {
          keyspaceCustomMask = keyspaceCustomMask * Math.pow(customCharsetToOptions(options.customCharset1), (mask.match(/\?1/g) || []).length);
        }
        if (options.customCharset2 !== "") {
          keyspaceCustomMask = keyspaceCustomMask * Math.pow(customCharsetToOptions(options.customCharset2), (mask.match(/\?2/g) || []).length);
        }
        if (options.customCharset3 !== "") {
          keyspaceCustomMask = keyspaceCustomMask * Math.pow(customCharsetToOptions(options.customCharset3), (mask.match(/\?3/g) || []).length);
        }
        if (options.customCharset4 !== "") {
          keyspaceCustomMask = keyspaceCustomMask * Math.pow(customCharsetToOptions(options.customCharset4), (mask.match(/\?4/g) || []).length);
        }

        var keyspaceRegularMask = 1;
        keyspaceRegularMask = Math.pow(95, (mask.match(/\?a/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(10, (mask.match(/\?d/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(26, (mask.match(/\?l/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(26, (mask.match(/\?u/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(33, (mask.match(/\?s/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(16, (mask.match(/\?h/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(16, (mask.match(/\?H/g) || []).length);
        keyspaceRegularMask = keyspaceRegularMask * Math.pow(256, (mask.match(/\?b/g) || []).length);

        return keyspaceRegularMask * keyspaceCustomMask;
      }

      var keyspace;
      if (options.attackType === 3) {
        for (var i = 0; i < options.posArgs.length; i++) {
          posArg = options.posArgs[i];
          if (posArg.includes("?")) {
            mask = posArg;
            keyspace = maskToKeyspace(mask);
            return [keyspace, options.attackType];
          }
        }
      }
      return [null, options.attackType];
    }
  </script>

  <script>
    $(".taskInSuper").each(function () {
      var auxiliaryKeyspace = $(this).find("td:nth-child(4)").text();
      var attackCmd = $(this).find("td:nth-child(3)").text();

      var keyspace_attackType_pair = calc_keyspace_size(attackCmd);
      var keyspace_size;

      if (auxiliaryKeyspace != 1) {
        keyspace_size = auxiliaryKeyspace;
      } else {
        keyspace_size = keyspace_attackType_pair[0];
      }

      $(this).find("td:nth-child(4)").html(keyspace_size);
    });

    $(".taskNotInSuper").each(function () {
      var filesCountLinesProduct = $(this).find("td:nth-child(4)").text();
      var attackCmd = $(this).find("td:nth-child(3)").text();

      var keyspace_attackType_pair = calc_keyspace_size(attackCmd);
      var keyspace_size;

      if (filesCountLinesProduct != 1) {
        keyspace_size = filesCountLinesProduct;
      } else {
        keyspace_size = keyspace_attackType_pair[0];
      }

      $(this).find("td:nth-child(4)").html(keyspace_size);
    });
  </script>

  {{IF [[benchmarka0]] != 0 AND [[benchmarka3]] != 0}}
    <input type="hidden" id="benchmarka0" value="[[benchmarka0]]">
    <input type="hidden" id="benchmarka3" value="[[benchmarka3]]">

    <script>
      var totalSecondsSupertask = 0;
      var unknown_runtime_included = 0;

      $(".taskInSuper").each(function () {
        var keyspace_size = $(this).find("td:nth-child(4)").text();
        var attackCmd = $(this).find("td:nth-child(3)").text();
        var keyspace_attackType_pair = calc_keyspace_size(attackCmd);

        var benchmarka0 = parseFloat($('#benchmarka0').val());
        var benchmarka3 = parseFloat($('#benchmarka3').val());

        var seconds = null;
        var runtime = "Unknown";

        if (keyspace_size === null) {
          unknown_runtime_included = 1;
        } else if (keyspace_attackType_pair[1] === 3 && benchmarka3 > 0) {
          seconds = Math.floor(keyspace_size / benchmarka3);
        } else if (keyspace_attackType_pair[1] === 0 && benchmarka0 > 0) {
          seconds = Math.floor(keyspace_size / benchmarka0);
        }

        if (Number.isInteger(seconds)) {
          totalSecondsSupertask += seconds;

          var days = Math.floor(seconds / (3600 * 24));
          seconds -= days * 3600 * 24;
          var hrs = Math.floor(seconds / 3600);
          seconds -= hrs * 3600;
          var mins = Math.floor(seconds / 60);
          seconds -= mins * 60;

          runtime = days + "d, " + hrs + "h, " + mins + "m, " + seconds + "s";
        } else {
          unknown_runtime_included = 1;
        }

        $(this).find("td:nth-child(5)").html(runtime);
      });

      var seconds = totalSecondsSupertask;
      var days = Math.floor(seconds / (3600 * 24));
      seconds -= days * 3600 * 24;
      var hrs = Math.floor(seconds / 3600);
      seconds -= hrs * 3600;
      var mins = Math.floor(seconds / 60);
      seconds -= mins * 60;

      var totalRuntimeSupertask = days + "d, " + hrs + "h, " + mins + "m, " + seconds + "s";
      if (unknown_runtime_included === 1) {
        totalRuntimeSupertask = totalRuntimeSupertask + ", plus additional unknown runtime";
      }
      $(".runtimeOfSupertask").html(totalRuntimeSupertask);

      $(".taskNotInSuper").each(function () {
        var keyspace_size = $(this).find("td:nth-child(4)").text();
        var attackCmd = $(this).find("td:nth-child(3)").text();
        var keyspace_attackType_pair = calc_keyspace_size(attackCmd);

        var benchmarka0 = parseFloat($('#benchmarka0').val());
        var benchmarka3 = parseFloat($('#benchmarka3').val());

        var seconds = null;
        var runtime = "Unknown";

        if (keyspace_attackType_pair[1] === 3 && benchmarka3 > 0) {
          seconds = Math.floor(keyspace_size / benchmarka3);
        }
        if (keyspace_attackType_pair[1] === 0 && benchmarka0 > 0) {
          seconds = Math.floor(keyspace_size / benchmarka0);
        }

        if (Number.isInteger(seconds)) {
          var days = Math.floor(seconds / (3600 * 24));
          seconds -= days * 3600 * 24;
          var hrs = Math.floor(seconds / 3600);
          seconds -= hrs * 3600;
          var mins = Math.floor(seconds / 60);
          seconds -= mins * 60;

          runtime = days + "d, " + hrs + "h, " + mins + "m, " + seconds + "s";
        }

        $(this).find("td:nth-child(5)").html(runtime);
      });
    </script>
  {{ENDIF}}

  <script type="text/javascript">
    $(document).ready(function () {
      $('#pretasksOfSupertasks').DataTable({
        pageLength: 10,
        order: [[0, 'asc'], [1, 'asc']],
        columnDefs: [{ orderable: true, targets: [0, 1, 2, 3, 4, 5] }]
      });

      $('td[rel=popover]').popover({
        html: true,
        trigger: 'hover',
        container: 'body',
        content: function () {
          return '<img style="width: 100%; height: 6px; padding: 0px;" src="' + $(this).data('img') + '">';
        }
      });
    });

    $(document).ready(function () {
      $('#remainingPretasks').DataTable({
        pageLength: 10,
        order: [[0, 'desc'], [1, 'asc']],
        columnDefs: [{ orderable: true, targets: [0, 1, 2, 3, 4, 5] }]
      });

      $('td[rel=popover]').popover({
        html: true,
        trigger: 'hover',
        container: 'body',
        content: function () {
          return '<img style="width: 100%; height: 6px; padding: 0px;" src="' + $(this).data('img') + '">';
        }
      });
    });
  </script>

{{ENDIF}}

{%TEMPLATE->struct/foot%}
