{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>API Management</h2>

{%TEMPLATE->struct/messages%}

<h3>API Access Groups</h3>
<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th colspan="4" class="text-center">
            <a href="api.php?new=true" class="btn btn-success">Create New API Group</a>
          </th>
        </tr>
        <tr>
          <th style="width: 80px;">ID</th>
          <th>Name</th>
          <th style="width: 140px;"># of Users</th>
          <th style="width: 140px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {{FOREACH group;[[groups]]}}
          <tr>
            <td>[[group.getId()]]</td>
            <td>[[htmlentities([[group.getName()]], ENT_QUOTES, "UTF-8")]]</td>
            <td>[[apis.getVal([[group.getId()]])]]</td>
            <td class="text-end">
              <div class="d-inline-flex gap-2">
                <a class="btn btn-primary"
                   href="api.php?id=[[group.getId()]]"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Edit">
                  <i class="fas fa-edit" aria-hidden="true"></i>
                </a>

                <form action="api.php" method="POST"
                      onsubmit="if (!confirm('Really delete api group [[htmlentities([[group.getName()]], ENT_QUOTES, 'UTF-8')]]?')) return false;">
                  <input type="hidden" name="action" value="[[$DApiAction::DELETE_GROUP]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <input type="hidden" name="groupId" value="[[group.getId()]]">
                  <button type="submit"
                          class="btn btn-danger"
                          {{IF [[apis.getVal([[group.getId()]])]] > 0}}disabled{{ENDIF}}
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="{{IF [[apis.getVal([[group.getId()]])]] > 0}}Cannot delete (has users){{ELSE}}Delete{{ENDIF}}">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {{ENDFOREACH}}
      </tbody>
    </table>
  </div>
</div>

<h3 class="mt-4">API Keys</h3>
<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th colspan="4" class="text-center">
            <a href="api.php?newkey=true" class="btn btn-success">Create New API Key</a>
          </th>
        </tr>
        <tr>
          <th style="width: 80px;">ID</th>
          <th style="width: 220px;">User</th>
          <th>Key</th>
          <th style="width: 140px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {{FOREACH key;[[keys]]}}
          <tr>
            <td>[[key.getId()]]</td>
            <td>[[Util::getUsernameById([[key.getUserId()]])]]</td>
            <td>
              <pre class="mb-0"><code>[[key.getAccessKey()]]</code></pre>
            </td>
            <td class="text-end">
              <div class="d-inline-flex gap-2">
                <a class="btn btn-primary"
                   href="api.php?keyId=[[key.getId()]]"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Edit">
                  <i class="fas fa-edit" aria-hidden="true"></i>
                </a>

                <form action="api.php" method="POST"
                      onsubmit="if (!confirm('Really delete this api key?')) return false;">
                  <input type="hidden" name="action" value="[[$DApiAction::DELETE_KEY]]">
                  <input type="hidden" name="csrf" value="[[csrf]]">
                  <input type="hidden" name="keyId" value="[[key.getId()]]">
                  <button type="submit"
                          class="btn btn-danger"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Delete">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {{ENDFOREACH}}
      </tbody>
    </table>
  </div>
</div>

{%TEMPLATE->struct/foot%}
