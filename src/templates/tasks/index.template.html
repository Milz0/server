{%TEMPLATE->struct/head%}
{%TEMPLATE->struct/menu%}

<h2>{{IF [[showArchived]]}}Archived {{ENDIF}}Tasks ([[sizeof([[taskList]])]])</h2>

{%TEMPLATE->struct/messages%}

<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
  {{IF [[accessControl.hasPermission([[$DAccessControl::CREATE_TASK_ACCESS]])]] && ![[showArchived]]}}
    <form action="tasks.php" method="POST"
          onsubmit="if (!confirm('Really delete all finished tasks?')) return false;">
      <input type="hidden" name="action" value="[[$DTaskAction::DELETE_FINISHED]]">
      <input type="hidden" name="csrf" value="[[csrf]]">
      <input type="submit" value="Delete finished" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}">
    </form>
  {{ENDIF}}

  {{IF [[accessControl.hasPermission([[$DAccessControl::CREATE_TASK_ACCESS]])]] && [[showArchived]]}}
    <form action="tasks.php?archived=true" method="POST"
          onsubmit="if (!confirm('Really delete all archived tasks?')) return false;">
      <input type="hidden" name="action" value="[[$DTaskAction::DELETE_ARCHIVED]]">
      <input type="hidden" name="csrf" value="[[csrf]]">
      <input type="submit" value="Delete archived" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}">
    </form>
  {{ENDIF}}

  {{IF [[showArchived]]}}
    <a href="tasks.php" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}">Show current</a>
  {{ELSE}}
    <a href="tasks.php?archived=true" class="btn {{IF [[toggledarkmode]] > 0}}btn-primary{{ELSE}}btn-light{{ENDIF}}">Show archived</a>
  {{ENDIF}}

  {%TEMPLATE->tasks/autorefresh%}
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle" id="tasks">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Hashlist</th>
          <th>Dispatched/Searched</th>
          <th>Cracked</th>
          <th>Agents</th>
          <th>Task Priority</th>
          <th>Max agents</th>
          <th style="min-width: 170px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {{FOREACH set;[[taskList]]}}
          {{IF [[set.getVal('taskType')]] == [[$DTaskTypes::NORMAL]]}}
            {%TEMPLATE->tasks/normal%}
          {{ELSE}}
            {%TEMPLATE->tasks/supertask%}
          {{ENDIF}}
        {{ENDFOREACH}}
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function () {
    $('#tasks').DataTable({
      pageLength: 50,
      order: [[6, 'desc'], [0, 'asc']],
      columnDefs: [
        { orderable: false, targets: [3, 8] }
      ]
    });
  });

  // Bootstrap 5 popover init (requires Bootstrap 5 bundle on the page)
  $(document).ready(function () {
    // Keep your existing selector contract: td[rel=popover] with data-img
    var els = document.querySelectorAll('td[rel="popover"]');
    els.forEach(function (el) {
      new bootstrap.Popover(el, {
        html: true,
        trigger: 'hover',
        container: 'body',
        content: function () {
          return '<img style="width: 100%; height: 6px; padding: 0px;" src="' + $(el).data('img') + '">';
        }
      });
    });
  });
</script>

{%TEMPLATE->struct/foot%}
